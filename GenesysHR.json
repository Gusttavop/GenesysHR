// ==UserScript==
// @name Genesys Helper Suite
// @namespace http://your-domain.com/
// @version 3.1.1
// @description Sistema unificado para cron√¥metro de conversas, busca de documentos (CPF/CNPJ) e c√≥pia combinada de informa√ß√µes do participante. (UI atualizada)
// @author AI Assistant
// @match *://*/*
// @grant GM_addStyle
// ==/UserScript==

(function() {
    'use strict';

    // ==================== CONFIGURATION ====================
    const CONFIG = {
        WATCHER_INTERVAL_MS: 1000,
        IFRAME_SRC: "https://apps.sae1.pure.cloud/messaging-gadget/messaging-gadget.html",

        // --- M√≥dulo de Busca de Documentos ---
        DOC_SEARCH: {
            SELECTORS: {
                iframe_chatContainer: '[data-automation-id="message-history"]',
                iframe_messageBody: '[data-automation-id="messaging-gadget-message-textbody"]',
                iframe_actionBar: '[data-automation-id="messaging-gadget-footer-actions"]',
                iframe_systemMessage: 'p[data-automation-id="message-history-system-message"]',
            },
            CLASSES: {
                button: 'doc-search-btn-v3',
                toolbar: 'genesys-helper-toolbar-v3'
            }
        },

        // --- M√≥dulo de C√≥pia Combinada ---
        COMBINED_COPY: {
            SELECTORS: {
                main_actionsContainer: '.actions-container',
                main_originalCopyButton: '.copy-action-button',
                main_participantName: '#interaction-header-participant-name',
            },
            CLASSES: {
                button: 'combined-copy-btn-v3',
                toolbar: 'genesys-helper-toolbar-v3'
            }
        },

        // Timer selectors kept from prior code if needed by other parts
        TIMER: {
            SELECTORS: {
                conversation: 'div.interaction-group',
                activeConversation: 'div.interaction-group.is-selected'
            },
            CLASSES: {
                container: 'ghs-timer-container',
                number: 'ghs-timer-number',
                running: 'ghs-timer-running',
                paused: 'ghs-timer-paused',
                completed: 'ghs-timer-completed'
            },
            LIMIT_TIME_MS: 60 * 1000,
            UPDATE_INTERVAL_MS: 1000,
            HOLD_TO_COMPLETE_MS: 1200
        }
    };

    // ==================== STYLES ====================
    const STYLES = `
        /* Toolbar for buttons (right aligned) */
        .${CONFIG.DOC_SEARCH.CLASSES.toolbar} {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
        }

        .${CONFIG.DOC_SEARCH.CLASSES.button}, .${CONFIG.COMBINED_COPY.CLASSES.button} {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
            transition: background-color 0.18s, transform 0.08s;
            background: #6b7280; /* gray */
            color: white;
            font-family: Arial, sans-serif;
            font-size: 13px;
            line-height: 1;
        }

        .${CONFIG.DOC_SEARCH.CLASSES.button}:hover, .${CONFIG.COMBINED_COPY.CLASSES.button}:hover {
            background: #4b5563; /* darker gray on hover */
        }

        .${CONFIG.DOC_SEARCH.CLASSES.button}:disabled, .${CONFIG.COMBINED_COPY.CLASSES.button}:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* small icon sizing override */
        .${CONFIG.DOC_SEARCH.CLASSES.button} svg,
        .${CONFIG.COMBINED_COPY.CLASSES.button} svg {
            width: 18px;
            height: 18px;
            display: block;
            flex-shrink: 0;
            fill: currentColor;
        }

        /* feedback toast (kept) */
        #copy-feedback-toast-v3 {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: #28a745; color: white; padding: 12px 20px;
            border-radius: 8px; z-index: 10001; font-family: Arial, sans-serif;
            font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            opacity: 0; pointer-events: none; transition: opacity 0.3s, bottom 0.3s;
        }
    `;

    // Apply styles
    if (typeof GM_addStyle === 'function') {
        GM_addStyle(STYLES);
    } else {
        const styleSheet = document.createElement("style");
        styleSheet.innerText = STYLES;
        document.head.appendChild(styleSheet);
    }

    // ==================== UTILITIES & SERVICES ====================

    class DocumentValidator {
        static validateCPF(cpf) {
            const cleanCPF = String(cpf).replace(/\D/g, '');
            if (cleanCPF.length !== 11 || /^(\d)\1{10}$/.test(cleanCPF)) return false;
            let sum = 0;
            for (let i = 0; i < 9; i++) sum += parseInt(cleanCPF.charAt(i),10) * (10 - i);
            let remainder = (sum * 10) % 11;
            if (remainder === 10) remainder = 0;
            if (remainder !== parseInt(cleanCPF.charAt(9),10)) return false;
            sum = 0;
            for (let i = 0; i < 10; i++) sum += parseInt(cleanCPF.charAt(i),10) * (11 - i);
            remainder = (sum * 10) % 11;
            if (remainder === 10) remainder = 0;
            return remainder === parseInt(cleanCPF.charAt(10),10);
        }

        static validateCNPJ(cnpj) {
            const cleanCNPJ = String(cnpj).replace(/\D/g, '');
            if (cleanCNPJ.length !== 14 || /^(\d)\1{13}$/.test(cleanCNPJ)) return false;
            const weights1 = [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            let sum = 0;
            for (let i = 0; i < 12; i++) sum += parseInt(cleanCNPJ.charAt(i),10) * weights1[i];
            let remainder = sum % 11;
            remainder = remainder < 2 ? 0 : 11 - remainder;
            if (remainder !== parseInt(cleanCNPJ.charAt(12),10)) return false;
            const weights2 = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            sum = 0;
            for (let i = 0; i < 13; i++) sum += parseInt(cleanCNPJ.charAt(i),10) * weights2[i];
            remainder = sum % 11;
            remainder = remainder < 2 ? 0 : 11 - remainder;
            return remainder === parseInt(cleanCNPJ.charAt(13),10);
        }

        /**
         * findDocuments: captura CPF/CNPJ no texto de forma tolerante.
         * - aceita formatos com ou sem pontua√ß√£o.
         * - se valida√ß√£o falhar para CPF, ainda retorna o n√∫mero (com valid:false) para possibilitar c√≥pia.
         */
        static findDocuments(text) {
            if (typeof text !== 'string' || !text) return [];
            const documents = new Map();

            // Regexs: captura CNPJ (com ou sem pontua√ß√£o) e CPF (com ou sem pontua√ß√£o) e tamb√©m sequ√™ncias de 11 ou 14 d√≠gitos
            const docRegex = /(\b\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}\b)|(\b\d{3}\.?\d{3}\.?\d{3}-?\d{2}\b)|(\b\d{11}\b)|(\b\d{14}\b)/g;
            const matches = text.match(docRegex) || [];

            for (const match of matches) {
                const cleanMatch = match.replace(/\D/g, '');
                if (cleanMatch.length === 11) {
                    // CPF-like
                    const isValid = this.validateCPF(cleanMatch);
                    // always include (valid or not), but avoid duplicates
                    if (!documents.has(cleanMatch)) {
                        documents.set(cleanMatch, {
                            type: 'CPF',
                            formatted: this.formatCPF(cleanMatch),
                            raw: cleanMatch,
                            valid: isValid
                        });
                    }
                } else if (cleanMatch.length === 14) {
                    const isValid = this.validateCNPJ(cleanMatch);
                    if (!documents.has(cleanMatch)) {
                        documents.set(cleanMatch, {
                            type: 'CNPJ',
                            formatted: this.formatCNPJ(cleanMatch),
                            raw: cleanMatch,
                            valid: isValid
                        });
                    }
                }
            }

            return Array.from(documents.values());
        }

        static formatCPF(cpf) {
            const s = String(cpf).replace(/\D/g, '').padStart(11,'0');
            return s.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }

        static formatCNPJ(cnpj) {
            const s = String(cnpj).replace(/\D/g, '').padStart(14,'0');
            return s.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
        }
    }

    class UIManager {
        constructor() {
            this.popupContainer = null;
            this.feedbackTimeout = null;
        }

        createPopup(title, bodyElement, borderColor = '#6b7280') {
            this.removePopup();
            this.popupContainer = document.createElement('div');

            const backdrop = document.createElement('div');
            backdrop.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;`;

            const modal = document.createElement('div');
            modal.style.cssText = `position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:2px solid ${borderColor}; border-radius:10px; padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:10000; max-width:420px; max-height:520px; overflow-y:auto; font-family:Arial,sans-serif;`;

            const header = document.createElement('div');
            header.style.cssText = `display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:10px;`;

            const heading = document.createElement('h3');
            heading.textContent = title;
            heading.style.cssText = `margin:0; color:${borderColor}; font-size:16px;`;

            const closeBtn = document.createElement('button');
            closeBtn.textContent = '√ó';
            closeBtn.style.cssText = `background:#dc3545; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; font-size:16px; display:flex; align-items:center; justify-content:center;`;

            header.appendChild(heading);
            header.appendChild(closeBtn);
            modal.appendChild(header);
            modal.appendChild(bodyElement);
            this.popupContainer.appendChild(backdrop);
            this.popupContainer.appendChild(modal);
            document.body.appendChild(this.popupContainer);

            closeBtn.addEventListener('click', () => this.removePopup());
            backdrop.addEventListener('click', () => this.removePopup());
        }

        showDocumentsPopup(documents) {
            const listContainer = document.createElement('div');

            documents.forEach(doc => {
                const isCPF = doc.type === 'CPF';
                const docElement = document.createElement('div');
                docElement.style.cssText = `margin-bottom:10px; padding:10px; background:${isCPF ? '#f3f4f6' : '#fff7ed'}; border-radius:6px; display:flex; justify-content:space-between; align-items:center; gap:12px;`;

                const textContainer = document.createElement('div');
                textContainer.style.cssText = 'display:flex; flex-direction:column; gap:4px;';
                const topLine = document.createElement('div');
                topLine.style.cssText = 'display:flex; gap:8px; align-items:center;';
                const typeStrong = document.createElement('strong');
                typeStrong.textContent = `${doc.type}`;
                typeStrong.style.color = '#111827';

                const validity = document.createElement('span');
                validity.textContent = doc.valid ? 'v√°lido' : 'poss√≠vel (n√£o validado)';
                validity.style.cssText = `font-size:12px; color:${doc.valid ? '#16a34a' : '#b45309'};`;

                topLine.append(typeStrong, validity);

                const valueSpan = document.createElement('span');
                valueSpan.textContent = doc.formatted || doc.raw;
                valueSpan.style.fontFamily = 'monospace';
                valueSpan.style.fontSize = '14px';

                textContainer.append(topLine, valueSpan);

                const actions = document.createElement('div');
                actions.style.cssText = 'display:flex; gap:8px;';

                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'Copiar';
                copyBtn.style.cssText = `background:#6b7280; color:white; border:none; border-radius:6px; padding:6px 8px; cursor:pointer; font-size:13px;`;
                copyBtn.addEventListener('click', async () => {
                    const toCopy = doc.formatted || doc.raw;
                    await this.copyToClipboard(toCopy, copyBtn, true);
                });

                actions.appendChild(copyBtn);
                docElement.append(textContainer, actions);
                listContainer.appendChild(docElement);
            });

            this.createPopup(`üìÑ Documentos Encontrados (${documents.length})`, listContainer, '#6b7280');
        }

        async copyToClipboard(text, buttonElement = null, closeModal = false) {
            try {
                if (!text) throw new Error('Texto vazio');
                await navigator.clipboard.writeText(text);
                this.showFeedbackToast('‚úÖ Copiado!');
            } catch {
                // fallback usando textarea
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    this.showFeedbackToast('‚úÖ Copiado usando fallback!');
                } catch {
                    this.showErrorPopup('N√£o foi poss√≠vel copiar para a √°rea de transfer√™ncia.');
                } finally {
                    textarea.remove();
                }
            }

            if (buttonElement) {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '‚úÖ';
                buttonElement.style.backgroundColor = '#16a34a';
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.style.backgroundColor = '#6b7280';
                    if (closeModal) this.removePopup();
                }, 900);
            } else if (closeModal) {
                setTimeout(() => this.removePopup(), 800);
            }
        }

        showFeedbackToast(message) {
            if (this.feedbackTimeout) clearTimeout(this.feedbackTimeout);
            let feedbackEl = document.getElementById('copy-feedback-toast-v3');
            if (!feedbackEl) {
                feedbackEl = document.createElement('div');
                feedbackEl.id = 'copy-feedback-toast-v3';
                feedbackEl.style.cssText = `position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#17a2b8; color:white; padding:10px 20px; border-radius:5px; font-family:Arial, sans-serif; font-size:14px; opacity:0; transition:all 0.3s; pointer-events:none; z-index:20000;`;
                document.body.appendChild(feedbackEl);
            }
            feedbackEl.textContent = message;
            setTimeout(() => {
                feedbackEl.style.opacity = '1';
                feedbackEl.style.bottom = '30px';
                feedbackEl.style.pointerEvents = 'auto';
            }, 10);

            this.feedbackTimeout = setTimeout(() => {
                feedbackEl.style.opacity = '0';
                feedbackEl.style.bottom = '20px';
                feedbackEl.style.pointerEvents = 'none';
                setTimeout(() => feedbackEl.remove(), 300);
            }, 2200);
        }

        showErrorPopup(errorMessage) {
            this.createPopup('Erro', (() => {
                const body = document.createElement('div');
                body.style.textAlign = 'center';
                const iconDiv = document.createElement('div');
                iconDiv.textContent = '‚ùå';
                iconDiv.style.fontSize = '40px';
                const messageP = document.createElement('p');
                messageP.textContent = errorMessage;
                body.append(iconDiv, messageP);
                return body;
            })(), '#dc3545');
        }

        removePopup() {
            this.popupContainer?.remove();
            this.popupContainer = null;
        }
    }

    // ==================== FEATURE MODULES ====================

    class ChatProcessor {
        constructor(iframeDocument, uiManager) {
            this.iframeDoc = iframeDocument;
            this.uiManager = uiManager;
        }

        extractTextFromMessages(chatContainer) {
            if (!chatContainer) return '';
            const messages = chatContainer.querySelectorAll(CONFIG.DOC_SEARCH.SELECTORS.iframe_messageBody);
            return Array.from(messages).map(msg => msg.textContent || '').join('\n');
        }

        async scrollToTop(chatContainer) {
            return new Promise(resolve => {
                let attempts = 0;
                const scrollInterval = setInterval(() => {
                    const systemMessage = chatContainer.querySelector(CONFIG.DOC_SEARCH.SELECTORS.iframe_systemMessage);
                    if ((systemMessage && systemMessage.offsetParent !== null) || ++attempts > 50) {
                        clearInterval(scrollInterval);
                        resolve();
                    } else {
                        chatContainer.scrollTop = 0;
                    }
                }, 100);
            });
        }

        async findAndProcessDocuments() {
            try {
                const chatContainer = this.iframeDoc.querySelector(CONFIG.DOC_SEARCH.SELECTORS.iframe_chatContainer);
                if (!chatContainer) throw new Error('Chat container not found inside the iframe.');

                await this.scrollToTop(chatContainer);
                await new Promise(resolve => setTimeout(resolve, 300));

                const messagesText = this.extractTextFromMessages(chatContainer);
                const documents = DocumentValidator.findDocuments(messagesText);

                if (documents.length === 1) {
                    const docToCopy = documents[0];
                    await this.uiManager.copyToClipboard(docToCopy.formatted || docToCopy.raw);
                    this.uiManager.showFeedbackToast(`Copiado: ${docToCopy.formatted || docToCopy.raw}`);
                } else if (documents.length > 1) {
                    this.uiManager.showDocumentsPopup(documents);
                } else {
                    this.uiManager.createPopup('Nenhum Documento', (() => {
                        const body = document.createElement('div');
                        body.style.textAlign = 'center';
                        const p = document.createElement('p');
                        p.textContent = 'Nenhum CPF/CNPJ encontrado na conversa.';
                        body.appendChild(p);
                        return body;
                    })(), '#6b7280');
                }
            } catch (error) {
                console.error('Error during document search:', error);
                this.uiManager.showErrorPopup(error.message || String(error));
            }
        }
    }

    class ButtonFactory {
        constructor() {
            this.uiManager = new UIManager();
            this.icons = {
                // search (CPF) improved icon (uses currentColor)
                search: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 20.49 21.49 19 15.5 14zM10 14a4 4 0 110-8 4 4 0 010 8z"/></svg>`,
                // clipboard icon for copy/url
                copy: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M16 1H8a2 2 0 00-2 2v2H5a2 2 0 00-2 2v11a2 2 0 002 2h10a2 2 0 002-2v-1h1a2 2 0 002-2V7a2 2 0 00-2-2h-1V3a2 2 0 00-2-2zM8 3h8v2H8V3zM19 9v9H5V9h14z"/></svg>`,
                loading: `<svg width="18" height="18" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><g><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-opacity="0.25"/><path d="M22 12a10 10 0 00-10-10" stroke="currentColor" stroke-width="2" fill="none"/></g></svg>`,
                success: `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/></svg>`
            };
        }

        /**
         * Creates the CPF document-search button.
         * If a main actions container exists on the page, both buttons are placed together there in a toolbar.
         */
        createDocSearchButton(iframeDoc) {
            const button = document.createElement('button');
            button.className = CONFIG.DOC_SEARCH.CLASSES.button;
            button.title = 'Buscar CPF/CNPJ na conversa';
            button.innerHTML = `${this.icons.search}<span style="display:none">Buscar</span>`;
            this.applyBaseStyles(button);

            button.addEventListener('click', async () => {
                const processor = new ChatProcessor(iframeDoc, this.uiManager);
                this.setButtonState(button, 'loading');
                await processor.findAndProcessDocuments();
                this.setButtonState(button, 'default', this.icons.search);
            });
            return button;
        }

        createCombinedCopyButton() {
            const button = document.createElement('button');
            button.className = CONFIG.COMBINED_COPY.CLASSES.button;
            button.title = 'Copiar nome e protocolo (URL/intera√ß√£o)';
            button.innerHTML = `${this.icons.copy}<span style="display:none">Copiar</span>`;
            this.applyBaseStyles(button);

            button.addEventListener('click', async () => {
                this.setButtonState(button, 'loading');
                try {
                    const originalCopyButton = document.querySelector(CONFIG.COMBINED_COPY.SELECTORS.main_originalCopyButton);
                    if (!originalCopyButton) throw new Error('Bot√£o de c√≥pia original n√£o encontrado.');
                    originalCopyButton.click();
                    await new Promise(resolve => setTimeout(resolve, 150));
                    const protocol = await navigator.clipboard.readText();
                    if (!protocol) throw new Error('N√£o foi poss√≠vel ler o protocolo/URL.');
                    const participantElem = document.querySelector(CONFIG.COMBINED_COPY.SELECTORS.main_participantName);
                    if (!participantElem) throw new Error('Nome do participante n√£o encontrado.');
                    const participantName = participantElem.textContent.trim();
                    await navigator.clipboard.writeText(`${participantName}\n${protocol}`);
                    this.setButtonState(button, 'success', this.icons.success, 1400, `${this.icons.copy}<span style="display:none">Copiar</span>`);
                    // feedback
                    this.uiManager.showFeedbackToast('Nome + Protocolo copiados!');
                } catch (error) {
                    console.error('Combined copy failed:', error);
                    this.uiManager.showErrorPopup(error.message || String(error));
                    this.setButtonState(button, 'error', this.icons.copy);
                }
            });

            return button;
        }

        applyBaseStyles(button, border = '1px solid rgba(255,255,255,0.06)') {
            Object.assign(button.style, {
                cursor: 'pointer',
                transition: 'background-color 0.18s, opacity 0.18s, transform 0.08s',
                display: 'inline-flex',
                alignItems: 'center',
                justifyContent: 'center',
                background: '#6b7280', // gray default
                borderRadius: '8px',
                padding: '6px 8px',
                border: border,
                gap: '6px',
                color: 'white',
                fontSize: '13px'
            });
            button.addEventListener('mouseenter', () => {
                if (!button.disabled) button.style.backgroundColor = '#4b5563';
                button.style.transform = 'translateY(-1px)';
            });
            button.addEventListener('mouseleave', () => {
                if (!button.disabled) button.style.backgroundColor = '#6b7280';
                button.style.transform = '';
            });
        }

        setButtonState(button, state, icon = null, timeout = 0, defaultIcon = null) {
            button.disabled = (state === 'loading');
            button.innerHTML = (state === 'loading') ? this.icons.loading : (icon || button.innerHTML);
            switch (state) {
                case 'success':
                    button.style.backgroundColor = '#16a34a';
                    break;
                case 'error':
                    button.style.backgroundColor = '#dc3545';
                    break;
                default:
                    button.style.backgroundColor = '#6b7280';
            }
            if (timeout > 0) {
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = defaultIcon || (icon || button.innerHTML);
                    button.style.backgroundColor = '#6b7280';
                }, timeout);
            }
        }
    }

    // ==================== MAIN APPLICATION ====================

    class GenesysHelperSuite {
        constructor() {
            this.buttonFactory = new ButtonFactory();
            this.uiManager = this.buttonFactory.uiManager;
            this.timers = new Map();
            this.observer = null;
            this.updateQueued = false;
        }

        init() {
            console.log('üöÄ Initializing Genesys Helper Suite v3.1.1...');
            this.startUnifiedWatcher();
        }

        /**
         * We try to inject both buttons into a single right-aligned toolbar in the main actions container.
         * - If the main actions container exists, we create (or reuse) a toolbar element there and append the two buttons (CPF then URL).
         * - If not available, we fall back to injecting into the iframe action bar (doc search) and main area (combined copy) separately (backwards compatibility).
         */
        injectButtonsIntoToolbar(iframe) {
            try {
                const mainActions = document.querySelector(CONFIG.COMBINED_COPY.SELECTORS.main_actionsContainer);
                // create buttons
                const docBtn = this.buttonFactory.createDocSearchButton(iframe.contentDocument);
                const copyBtn = this.buttonFactory.createCombinedCopyButton();

                if (mainActions) {
                    // create or reuse toolbar
                    let toolbar = mainActions.querySelector(`.${CONFIG.DOC_SEARCH.CLASSES.toolbar}`);
                    if (!toolbar) {
                        toolbar = document.createElement('div');
                        toolbar.className = CONFIG.DOC_SEARCH.CLASSES.toolbar;
                        toolbar.style.cssText = 'display:flex; align-items:center; gap:8px; justify-content:flex-end;';
                        // append toolbar at end of actions container
                        mainActions.appendChild(toolbar);
                    }
                    // ensure order: CPF (left) then COPY (right)
                    // remove existing instances to avoid duplicates
                    [docBtn, copyBtn].forEach(b => {
                        // nothing: these are newly created buttons; but ensure toolbar doesn't already contain instances from previous injections
                    });

                    // append in order
                    toolbar.appendChild(docBtn);
                    toolbar.appendChild(copyBtn);
                    return true;
                } else {
                    // fallback: try to place docs button into iframe action bar (original behavior)
                    const actionBar = iframe.contentDocument?.querySelector(CONFIG.DOC_SEARCH.SELECTORS.iframe_actionBar);
                    if (actionBar && !actionBar.querySelector(`.${CONFIG.DOC_SEARCH.CLASSES.button}`)) {
                        actionBar.appendChild(docBtn);
                    }
                    // fallback for combined copy: place in main actions if found later by periodic injector (handled elsewhere)
                    const mainArea = document.querySelector(CONFIG.COMBINED_COPY.SELECTORS.main_actionsContainer);
                    if (mainArea && !mainArea.querySelector(`.${CONFIG.COMBINED_COPY.CLASSES.button}`)) {
                        mainArea.appendChild(copyBtn);
                    }
                    return false;
                }
            } catch (e) {
                console.warn('injectButtonsIntoToolbar: fallback due to error', e);
                return false;
            }
        }

        injectDocSearchButton() {
            // find target iframes inside DOM
            const iframes = this.findTargetIframes();
            iframes.forEach(iframe => {
                try {
                    // if main actions area exists, inject both into toolbar
                    const injectedToToolbar = this.injectButtonsIntoToolbar(iframe);
                    if (!injectedToToolbar) {
                        // if toolbar injection not possible, try original simple injection into iframe action bar
                        const actionBar = iframe.contentDocument?.querySelector(CONFIG.DOC_SEARCH.SELECTORS.iframe_actionBar);
                        if (actionBar && !actionBar.querySelector(`.${CONFIG.DOC_SEARCH.CLASSES.button}`)) {
                            actionBar.appendChild(this.buttonFactory.createDocSearchButton(iframe.contentDocument));
                        }
                    }
                } catch (e) {
                    // ignore cross-origin or other errors silently
                }
            });
        }

        injectCombinedCopyButton() {
            // This method remains more cautious: if main actions container exists but toolbar not created, create the toolbar and add both buttons.
            const mainActions = document.querySelector(CONFIG.COMBINED_COPY.SELECTORS.main_actionsContainer);
            if (mainActions && !mainActions.querySelector(`.${CONFIG.COMBINED_COPY.CLASSES.button}`)) {
                // create toolbar if missing
                let toolbar = mainActions.querySelector(`.${CONFIG.DOC_SEARCH.CLASSES.toolbar}`);
                if (!toolbar) {
                    toolbar = document.createElement('div');
                    toolbar.className = CONFIG.DOC_SEARCH.CLASSES.toolbar;
                    toolbar.style.cssText = 'display:flex; align-items:center; gap:8px; justify-content:flex-end;';
                    mainActions.appendChild(toolbar);
                }
                // create CPF button (if iframe present we try to create with iframe doc to enable search)
                const anyIframe = this.findTargetIframes()[0];
                let docBtn = null;
                if (anyIframe) {
                    docBtn = this.buttonFactory.createDocSearchButton(anyIframe.contentDocument);
                } else {
                    // create a non-functional placeholder (still usable if iframe later appears)
                    docBtn = document.createElement('button');
                    docBtn.className = CONFIG.DOC_SEARCH.CLASSES.button;
                    docBtn.innerHTML = `${this.buttonFactory.icons.search}<span style="display:none">Buscar</span>`;
                    this.buttonFactory.applyBaseStyles(docBtn);
                    docBtn.title = 'Buscar CPF/CNPJ na conversa (aguardando iframe)';
                    docBtn.addEventListener('click', () => this.uiManager.showFeedbackToast('Aguardando chat iframe para buscar documentos...'));
                }

                const copyBtn = this.buttonFactory.createCombinedCopyButton();

                // avoid duplicates: remove existing instances of our buttons (older runs)
                const existingToolbarBtns = toolbar.querySelectorAll(`.${CONFIG.DOC_SEARCH.CLASSES.button}, .${CONFIG.COMBINED_COPY.CLASSES.button}`);
                existingToolbarBtns.forEach(el => el.remove());

                toolbar.appendChild(docBtn);   // CPF left
                toolbar.appendChild(copyBtn);  // copy right
            }
        }

        startUnifiedWatcher() {
            console.log('üì° Unified Watcher enabled (UI changes active).');
            const handleMutations = (mutations) => {
                let needsTimerUpdate = false;
                for (const mutation of mutations) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1 && node.matches(CONFIG.TIMER.SELECTORS.conversation)) {
                                // optional: integrate timers from other part of your script
                                needsTimerUpdate = true;
                            }
                        });
                        if (mutation.removedNodes.length > 0) needsTimerUpdate = true;
                    }
                    if (mutation.attributeName === 'class') needsTimerUpdate = true;
                }
                // try to inject toolbar/buttons (idempotent)
                this.injectDocSearchButton();
                this.injectCombinedCopyButton();
                if (needsTimerUpdate) this.queueUpdate?.();
            };

            this.observer = new MutationObserver(handleMutations);
            this.observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true,
                attributeFilter: ['class']
            });

            // periodic attempts to inject (helps when elements load later)
            setInterval(() => {
                this.injectDocSearchButton();
                this.injectCombinedCopyButton();
            }, CONFIG.WATCHER_INTERVAL_MS * 2);
        }

        // helpers reused from earlier script if needed
        findTargetIframes(root = document) {
            let results = [];
            root.querySelectorAll('iframe').forEach(iframe => {
                try {
                    if (iframe.src && iframe.src.startsWith(CONFIG.IFRAME_SRC)) results.push(iframe);
                } catch(e){}
            });
            // search inside shadow roots
            root.querySelectorAll('*').forEach(el => {
                if (el.shadowRoot) {
                    results = results.concat(this.findTargetIframes(el.shadowRoot));
                }
            });
            return results;
        }
    }

    // ==================== INITIALIZATION ====================
    const app = new GenesysHelperSuite();
    app.init();

})();











// ==UserScript==
// @name         M√°scara de Atendimento (corrigido)
// @namespace    http://tampermonkey.net/
// @version      1.4.1
// @description  Adiciona um bot√£o flutuante que abre um sidebar com overlay controlado por uma vari√°vel global.
// @author       Voc√™
// @match        https://revan-atendimento.brisanet.net.br/*
// @grant        GM_addStyle
// ==/UserScript==

(function () {
  "use strict";

  // Global state
  window.ItemSelectorState = {
    jsonData: [],
    availableTags: new Set(),
    selectedItem: null,
    mensagemFinal: "",
    elements: null,
    onItemSelectedCallback: null,
  };

  // Use only window.tagResult (padronizado)
  window.tagResult = false;

  // Add tagExt function to the global scope
  window.tagExt = () => {
    if (!window.ItemSelectorState?.selectedItem) {
      console.log("tagExt: nenhum item selecionado");
      return false;
    }

    const spans = Array.from(
      document.querySelectorAll("div.tags > div.tag > nz-tag > span")
    );
    const tags = spans.map(tag => tag.textContent?.trim()).filter(Boolean);
    // store on globalThis for compatibility with other scripts if necessary
    globalThis.globalAvailableTags = new Set(tags);
    console.log("Tags extra√≠das:", tags);

    const selectedTag = window.ItemSelectorState.selectedItem.etiqueta;
    const resultTag = globalThis.globalAvailableTags.has(selectedTag);
    console.log("Tag availability:", resultTag);
    if (!resultTag) {
      console.log("Iniciando sequ√™ncia de a√ß√µes para tag n√£o dispon√≠vel (tagExt)");
    }
    window.tagResult = resultTag;
    return resultTag;
  };

  // Global ItemSelector interface
  window.ItemSelector = {
    getSelectedItem: () => {
      if (!window.ItemSelectorState.selectedItem) {
        console.log("No item currently selected");
        return null;
      }
      return window.ItemSelectorState.selectedItem;
    },
    getFormattedMessage: () => {
      const message = window.construirMensagemFinal();
      if (!message) {
        console.log("No message available");
        return "";
      }
      return message;
    },
    getFormData: () => {
      const state = window.ItemSelectorState;
      if (!state.selectedItem) return null;
      const elements = state.elements;
      return {
        item: state.selectedItem,
        isHolder: !!elements.holderCheckbox.querySelector("input").checked,
        speaker: elements.speakerInput.value || "",
        relationship:
          elements.relationshipSelect.querySelector("select").value || "",
        observations: elements.observationsTextarea.value || "",
        isExternalCall:
          !!elements.externalCallCheckbox.querySelector("input").checked,
        hasReminder: !!elements.reminderCheckbox.querySelector("input").checked,
        isImportant: !!elements.importantCheckbox.querySelector("input").checked,
        finalMessage: window.construirMensagemFinal(),
      };
    },
    onItemSelected: callback => {
      if (typeof callback !== "function") return;
      window.ItemSelectorState.onItemSelectedCallback = callback;
    },
  };

  // Make construirMensagemFinal globally accessible
  window.construirMensagemFinal = () => {
    if (window.ItemSelectorState.mensagemFinal) {
      return window.ItemSelectorState.mensagemFinal;
    }

    if (!window.ItemSelectorState.selectedItem) return "";

    let inicioMensagem = "";
    const holderCheckbox = window.ItemSelectorState.elements.holderCheckbox;
    const speakerInput = window.ItemSelectorState.elements.speakerInput;
    const relationshipSelect =
      window.ItemSelectorState.elements.relationshipSelect;

    if (holderCheckbox.querySelector("input").checked) {
      inicioMensagem = "Pr√≥prio titular - ";
    } else if (speakerInput.value) {
      const relationship = relationshipSelect.querySelector("select").value;
      inicioMensagem = `${speakerInput.value} - ${relationship} - `;
    } else {
      inicioMensagem = "Cliente - ";
    }

    const corpoMensagem = window.ItemSelectorState.selectedItem.mensagem || "";

    let finalMensagem = "";
    const observationsTextarea =
      window.ItemSelectorState.elements.observationsTextarea;
    if (observationsTextarea.value.trim()) {
      finalMensagem = ` Observa√ß√£o: ${observationsTextarea.value.trim()}`;
    }

    return `${inicioMensagem}${corpoMensagem}${finalMensagem}`.trim();
  };

  function createElements() {
    const button = document.createElement("button");
    button.id = "openSidebarBtn";
    button.setAttribute("aria-label", "Abrir M√°scara de Atendimento");
    button.innerHTML =
      '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M460-320v-320L300-480l160 160ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm440-80h120v-560H640v560Zm-80 0v-560H200v560h360Zm80 0h120-120Z"/></svg>';
    document.body.appendChild(button);

    const sidebar = document.createElement("div");
    sidebar.id = "sidebar";

    const header = document.createElement("header");
    header.textContent = "M√°scara de Atendimento";
    sidebar.appendChild(header);

    const searchContainer = document.createElement("div");
    searchContainer.id = "searchContainer";

    const inputWrapper = document.createElement("div");
    inputWrapper.className = "input-wrapper";

    const searchInput = document.createElement("input");
    searchInput.type = "text";
    searchInput.id = "searchInput";
    searchInput.placeholder = "Selecione um problema";

    const clearButton = document.createElement("button");
    clearButton.className = "clear-button";
    clearButton.innerHTML = "√ó";
    clearButton.style.display = "none";
    clearButton.setAttribute("aria-label", "Limpar sele√ß√£o");

    inputWrapper.appendChild(searchInput);
    inputWrapper.appendChild(clearButton);
    searchContainer.appendChild(inputWrapper);
    sidebar.appendChild(searchContainer);

    const dropdown = document.createElement("ul");
    dropdown.id = "dropdown";
    dropdown.style.display = "none";
    sidebar.appendChild(dropdown);

    const specificationSection = document.createElement("div");
    specificationSection.id = "specificationSection";
    specificationSection.style.display = "none";

    const specificationTitle = document.createElement("h3");
    specificationTitle.textContent = "Especifica√ß√µes do problema";
    specificationSection.appendChild(specificationTitle);

    const externalCallCheckbox = createCheckbox(
      "externalCallCheckbox",
      "Aguardar chamado externo?"
    );
    externalCallCheckbox.style.display = "none";
    specificationSection.appendChild(externalCallCheckbox);

    const reminderCheckbox = createCheckbox(
      "reminderCheckbox",
      "Finalizar com lembrete"
    );
    reminderCheckbox.style.display = "none";
    specificationSection.appendChild(reminderCheckbox);

    const importantCheckbox = createCheckbox(
      "importantCheckbox",
      "Chamado importante"
    );
    importantCheckbox.style.display = "none";
    specificationSection.appendChild(importantCheckbox);

    const observationsTextarea = document.createElement("textarea");
    observationsTextarea.id = "observationsTextarea";
    observationsTextarea.placeholder = "Observa√ß√µes";
    observationsTextarea.rows = 3;
    observationsTextarea.style.display = "none";
    specificationSection.appendChild(observationsTextarea);

    sidebar.appendChild(specificationSection);

    const clientDataSection = document.createElement("div");
    clientDataSection.id = "clientDataSection";

    const clientDataTitle = document.createElement("h3");
    clientDataTitle.textContent = "Dados do cliente";
    clientDataSection.appendChild(clientDataTitle);

    const holderCheckbox = createCheckbox("holderCheckbox", "Fala com o titular");
    clientDataSection.appendChild(holderCheckbox);

    const speakerInput = document.createElement("input");
    speakerInput.type = "text";
    speakerInput.id = "speakerInput";
    speakerInput.placeholder = "Quem fala";
    speakerInput.style.display = "none";
    clientDataSection.appendChild(speakerInput);

    const relationshipSelect = createSelect(
      "relationshipSelect",
      "Grau de parentesco",
      [
        { value: "Cliente", text: "N√£o informado" },
        { value: "Esposo(a) do(a) titular", text: "Esposo(a) do(a) titular" },
        { value: "M√£e do(a) titular", text: "M√£e do(a) titular" },
        { value: "Pai do(a) titular", text: "Pai do(a) titular" },
        { value: "Filho(a) do(a) titular", text: "Filho(a) do(a) titular" },
        { value: "Neto(a) do(a) titular", text: "Neto(a) do(a) titular" },
        { value: "Amigo(a) do(a) titular", text: "Amigo(a) do(a) titular" },
        { value: "Funcion√°rio(a) do(a) titular", text: "Funcion√°rio(a) do(a) titular" },
        { value: "Namorado(a) do(a) titular", text: "Namorado(a) do(a) titular" },
        { value: "Irm√£o(√£) do(a) titular", text: "Irm√£o(√£) do(a) titular" },
        { value: "Sobrinho(a) do(a) titular", text: "Sobrinho(a) do(a) titular" },
        { value: "Av√¥(√≥) do(a) titular", text: "Av√¥(√≥) do(a) titular" },
        { value: "Genro/Nora do(a) titular", text: "Genro/Nora do(a) titular" },
        { value: "Cunhado(a) do(a) titular", text: "Cunhado(a) do(a) titular" },
        { value: "Enteado(a) do(a) titular", text: "Enteado(a) do(a) titular" },
        { value: "Tutor(a) do(a) titular", text: "Tutor(a) do(a) titular" },
        { value: "S√≥cio(a) do(a) titular", text: "S√≥cio(a) do(a) titular" },
        { value: "Vizinho(a) do(a) titular", text: "Vizinho(a) do(a) titular" },
        { value: "Padrasto/Madrasta do(a) titular", text: "Padrasto/Madrasta do(a) titular" },
        { value: "Parente do(a) titular", text: "Parente do(a) titular" },
      ]
    );
    relationshipSelect.style.display = "none";
    clientDataSection.appendChild(relationshipSelect);

    sidebar.appendChild(clientDataSection);

    const buttonContainer = document.createElement("div");
    buttonContainer.className = "button-container";
    buttonContainer.style.display = "none";

    const sendButton = document.createElement("button");
    sendButton.textContent = "Enviar";
    sendButton.className = "send-button";
    const editButton = document.createElement("button");
    editButton.textContent = "Editar antes de enviar";
    editButton.className = "edit-button";
    editButton.addEventListener("click", e => {
      e.preventDefault();
      console.log("Editando antes de enviar...");
      openEditModal();
    });

    buttonContainer.appendChild(sendButton);
    buttonContainer.appendChild(editButton);
    sidebar.appendChild(buttonContainer);

    const previewSection = document.createElement("div");
    previewSection.id = "previewSection";
    previewSection.style.display = "none";

    const internalLabelPreview = document.createElement("div");
    internalLabelPreview.id = "internalLabelPreview";
    internalLabelPreview.className = "preview-item";
    previewSection.appendChild(internalLabelPreview);

    const externalLabelPreview = document.createElement("div");
    externalLabelPreview.id = "externalLabelPreview";
    externalLabelPreview.className = "preview-item";
    previewSection.appendChild(externalLabelPreview);

    const finalMessagePreview = document.createElement("div");
    finalMessagePreview.id = "finalMessagePreview";
    finalMessagePreview.className = "preview-item";
    previewSection.appendChild(finalMessagePreview);

    sidebar.appendChild(previewSection);

    const editModal = document.createElement("div");
    editModal.id = "editModal";
    editModal.className = "modal";
    editModal.style.display = "none";

    const modalContent = document.createElement("div");
    modalContent.className = "modal-content";

    const closeBtn = document.createElement("span");
    closeBtn.className = "close";
    closeBtn.innerHTML = "&times;";
    closeBtn.onclick = closeEditModal;

    const modalTitle = document.createElement("h2");
    modalTitle.textContent = "Editar Mensagem Final";

    const editMessageTextarea = document.createElement("textarea");
    editMessageTextarea.id = "editMessageTextarea";

    const buttonContainerEdit = document.createElement("div");
    buttonContainerEdit.id = "buttonContainerEdit";

    const saveEditButton = document.createElement("button");
    saveEditButton.id = "saveEditButton";
    saveEditButton.textContent = "Salvar Edi√ß√£o";
    saveEditButton.onclick = saveEdit;

    const cancelEditButton = document.createElement("button");
    cancelEditButton.id = "cancelEditButton";
    cancelEditButton.textContent = "Cancelar Edi√ß√£o";
    cancelEditButton.onclick = closeEditModal;

    buttonContainerEdit.appendChild(saveEditButton);
    buttonContainerEdit.appendChild(cancelEditButton);

    modalContent.appendChild(closeBtn);
    modalContent.appendChild(modalTitle);
    modalContent.appendChild(editMessageTextarea);
    modalContent.appendChild(buttonContainerEdit);

    editModal.appendChild(modalContent);

    // don't append sidebar here - init() will append it (keeps behavior consistent)
    const overlay = document.createElement("div");
    overlay.id = "sidebar-overlay";
    document.body.appendChild(overlay);

    return {
      sidebar,
      searchInput,
      clearButton,
      dropdown,
      overlay,
      specificationSection,
      externalCallCheckbox,
      reminderCheckbox,
      importantCheckbox,
      holderCheckbox,
      relationshipSelect,
      speakerInput,
      observationsTextarea,
      buttonContainer,
      previewSection,
      internalLabelPreview,
      externalLabelPreview,
      finalMessagePreview,
      editModal,
      editMessageTextarea,
      buttonContainerEdit,
      saveEditButton,
      cancelEditButton,
    };
  }

  function createCheckbox(id, label) {
    const checkboxContainer = document.createElement("div");
    checkboxContainer.className = "checkbox-container";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.id = id;
    checkbox.className = "checkbox-input";

    const checkboxLabel = document.createElement("label");
    checkboxLabel.htmlFor = id;
    checkboxLabel.textContent = label;

    checkboxContainer.appendChild(checkbox);
    checkboxContainer.appendChild(checkboxLabel);

    return checkboxContainer;
  }

  function createSelect(id, label, options) {
    const selectContainer = document.createElement("div");
    selectContainer.className = "select-container";

    const selectLabel = document.createElement("label");
    selectLabel.textContent = label;
    selectLabel.htmlFor = id;
    selectContainer.appendChild(selectLabel);

    const select = document.createElement("select");
    select.id = id;
    select.className = "custom-select";

    options.forEach(option => {
      const optionElement = document.createElement("option");
      optionElement.value = option.value;
      optionElement.textContent = option.text;
      select.appendChild(optionElement);
    });

    selectContainer.appendChild(select);

    return selectContainer;
  }

  function addStyles() {
    const style = document.createElement("style");
    style.textContent = `
      #openSidebarBtn {
        position: fixed;
        top: 112px;
        right: 20px;
        padding: 12px;
        background-color: #0858ce;
        border: none;
        cursor: move;
        z-index: 999;
        border-radius: 8px;
        transition: background-color 0.2s, transform 0.2s;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        user-select: none;
        touch-action: none;
      }

      #openSidebarBtn:hover {
        background-color: #001658;
        transform: scale(1.05);
      }

      #openSidebarBtn:active {
        cursor: grabbing;
      }

      #sidebar {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100%;
        background-color: #f0f4f9;
        transition: right 0.3s ease-in-out;
        box-shadow: -2px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        overflow-y: auto;
      }

      #sidebar.open {
        right: 0;
      }

      #sidebar header {
        color: white;
        padding: 48px 32px 61px 32px;
        font-size: 24px;
        font-weight: 600;
        min-height: 150px;
        text-align: center;
        background: #000C3E;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      #searchContainer {
        padding: 24px 20px;
        position: absolute;
        width: 100%;
        top: 104px;
      }

      .input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        border: 2px solid #ddd;
        border-radius: 10px;
        background-color: white;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .input-wrapper:focus-within {
        border-color: #2196F3;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }

      #searchInput {
        width: 100%;
        padding: 12px 16px;
        font-size: 16px;
        border: none;
        border-radius: 10px;
        background-color: transparent;
      }

      #searchInput:focus {
        outline: none;
      }

      .clear-button {
        position: absolute;
        right: 12px;
        background: none;
        border: none;
        color: #6B7280;
        font-size: 24px;
        cursor: pointer;
        padding: 0 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.3s;
      }

      .clear-button:hover {
        color: #374151;
      }

      #dropdown {
        list-style-type: none;
        padding: 0;
        margin: 0;
        max-height: 200px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 10px;
        position: absolute;
        width: calc(100% - 40px);
        left: 20px;
        top: 180px;
        z-index: 1002;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #dropdown li {
        padding: 12px 32px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 14px;
        color: #1F2937;
      }

      #dropdown li:hover {
        background-color: #F3F4F6;
      }

      #dropdown::-webkit-scrollbar {
        width: 8px;
      }

      #dropdown::-webkit-scrollbar-track {
        background: #F3F4F6;
      }

      #dropdown::-webkit-scrollbar-thumb {
        background: #D1D5DB;
        border-radius: 4px;
      }

      #dropdown::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF;
      }

      #sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(2px);
      }

      #specificationSection, #clientDataSection {
        background-color: #ffffff;
        margin: 40px 20px 12px;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      #specificationSection h3, #clientDataSection h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: #000C3E;
        border-bottom: 2px solid #e0e7ff;
        padding-bottom: 8px;
      }

      .checkbox-container, .select-container {
        margin-top: 16px;
      }

      .checkbox-container label, .select-container label {
        display: inline-block;
        margin-left: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #4B5563;
      }

      .checkbox-input {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid #D1D5DB;
        border-radius: 4px;
        outline: none;
        cursor: pointer;
        vertical-align: middle;
        transition: background-color 0.3s, border-color 0.3s;
      }

      .checkbox-input:checked {
        background-color: #2196F3;
        border-color: #2196F3;
      }

      .checkbox-input:checked::after {
        content: '‚úì';
        display: block;
        text-align: center;
        color: white;
        font-size: 14px;
        line-height: 18px;
      }

      .checkbox-input:focus {
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }

      .custom-select {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #D1D5DB;
        border-radius: 6px;
        background-color: white;
        color: #1F2937;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%234B5563'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .custom-select:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      #speakerInput {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #D1D5DB;
        border-radius: 6px;
        background-color: white;
        color: #1F2937;
        margin-top: 12px;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      #speakerInput:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      #observationsTextarea {
        width: 100%;
        padding: 10px 12px;
        font-size: 14px;
        border: 2px solid #D1D5DB;
        border-radius: 6px;
        background-color: white;
        color: #1F2937;
        margin-top: 12px;
        resize: vertical;
        min-height: 100px;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      #observationsTextarea:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .button-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      .send-button, .edit-button {
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
      }

      .send-button {
        background-color: #2196F3;
        color: white;
        border: none;
      }

      .send-button:hover {
        background-color: #1e88e5;
        transform: translateY(-2px);
      }

      .edit-button {
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ccc;
      }

      .edit-button:hover {
        background-color: #e0e0e0;
        transform: translateY(-2px);
      }

      .checkbox-container {
        display: flex;
        align-items: center;
        margin-top: 12px;
      }

      #specificationSection .checkbox-container {
        display: none;
      }

      #specificationSection.active .checkbox-container {
        display: flex;
      }

      #previewSection {
        background-color: #ffffff;
        margin: 20px;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .preview-item {
        margin-bottom: 12px;
        padding: 12px;
        background-color: #f0f4f9;
        border-radius: 8px;
        border: 1px solid #e0e7ff;
        transition: box-shadow 0.3s;
      }

      .preview-item h4 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #000C3E;
      }

      .preview-item p {
        font-size: 12px;
        color: #4B5563;
        line-height: 1.4;
        margin: 0;
      }

      .send-button:disabled, .edit-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      @media (max-width: 768px) {
        #sidebar {
          width: 100%;
          right: -100%;
        }

        #searchContainer {
          top: 60px;
        }

        #sidebar header {
          min-height: 120px;
          padding: 30px 20px 20px;
        }

        .button-container {
          flex-direction: column;
        }

        .send-button, .edit-button {
          width: 100%;
        }
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1003;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
      }

      #editMessageTextarea {
        width: 100%;
        height: 200px;
        margin-bottom: 20px;
        padding: 12px;
        border: 2px solid #D1D5DB;
        border-radius: 6px;
        font-size: 14px;
        resize: vertical;
      }

      #editMessageTextarea:focus {
        outline: none;
        border-color: #3B82F6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      #buttonContainerEdit {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      #saveEditButton, #cancelEditButton {
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
      }

      #saveEditButton {
        background-color: #10B981;
        color: white;
        border: none;
      }

      #saveEditButton:hover {
        background-color: #059669;
        transform: translateY(-2px);
      }

      #cancelEditButton {
        background-color: #F3F4F6;
        color: #111827;
        border: 1px solid #D1D5DB;
      }

      #cancelEditButton:hover {
        background-color: #E5E7EB;
        transform: translateY(-2px);
      }
    `;
    document.head.appendChild(style);
  }

  function setupEventListeners() {
    const elements = window.ItemSelectorState.elements;
    if (!elements) return console.error("setupEventListeners: elements faltando");

    const {
      searchInput,
      clearButton,
      dropdown,
      overlay,
      specificationSection,
      externalCallCheckbox,
      reminderCheckbox,
      importantCheckbox,
      holderCheckbox,
      relationshipSelect,
      speakerInput,
      observationsTextarea,
      buttonContainer,
      previewSection,
      sidebar,
      editModal,
      editMessageTextarea,
      saveEditButton,
      cancelEditButton,
    } = elements;

    const openSidebarBtn = document.getElementById("openSidebarBtn");
    if (!openSidebarBtn) {
      console.error("Open sidebar button not found");
      return;
    }

    openSidebarBtn.addEventListener("click", () => {
      sidebar.classList.add("open");
      overlay.style.display = "block";
      updateAvailableTags();
      filterAndDisplayItems();
      console.log(
        "Tags atuais da p√°gina:",
        Array.from(window.ItemSelectorState.availableTags)
      );
    });

    overlay.addEventListener("click", () => {
      sidebar.classList.remove("open");
      overlay.style.display = "none";
      closeEditModal();
    });

    searchInput.addEventListener("input", () => {
      filterAndDisplayItems();
      dropdown.style.display = "block";
      searchInput.style.borderRadius = "10px 10px 0 0";
    });

    searchInput.addEventListener("focus", () => {
      dropdown.style.display = "block";
      searchInput.style.borderRadius = "10px 10px 0 0";
    });

    clearButton.addEventListener("click", e => {
      e.stopPropagation();
      searchInput.value = "";
      window.ItemSelectorState.selectedItem = null;
      clearButton.style.display = "none";
      specificationSection.style.display = "none";
      buttonContainer.style.display = "none";
      previewSection.style.display = "none";
      closeEditModal();
      resetElementsToDefault();
      filterAndDisplayItems();
      updateButtonState();
      console.log("Item selecionado:", window.ItemSelectorState.selectedItem);
    });

    document.addEventListener("click", e => {
      if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = "none";
        searchInput.style.borderRadius = "10px";
      }
    });

    externalCallCheckbox
      .querySelector("input")
      .addEventListener("change", updatePreview);
    reminderCheckbox
      .querySelector("input")
      .addEventListener("change", updatePreview);
    importantCheckbox
      .querySelector("input")
      .addEventListener("change", updatePreview);

    holderCheckbox.querySelector("input").addEventListener("change", e => {
      speakerInput.style.display = e.target.checked ? "none" : "block";
      relationshipSelect.style.display = e.target.checked ? "none" : "block";
      updatePreview();
    });
    speakerInput.addEventListener("input", updatePreview);
    relationshipSelect.addEventListener("change", updatePreview);
    observationsTextarea.addEventListener("input", updatePreview);
    saveEditButton.addEventListener("click", saveEdit);
    cancelEditButton.addEventListener("click", closeEditModal);

    // Set initial state for holderCheckbox
    holderCheckbox.querySelector("input").checked = true;
    speakerInput.style.display = "none";
    relationshipSelect.style.display = "none";

    const sendButton = buttonContainer.querySelector(".send-button");
    if (sendButton) {
      sendButton.addEventListener("click", e => {
        e.preventDefault();
        console.log("Enviando...");
        try {
          window.tagExt(); // Call tagExt function here
          console.log("tagResult antes do envio:", window.tagResult);
          executarAutomacao().catch(err => console.error("exec automacao:", err));
        } catch (err) {
          console.error("Erro ao chamar tagExt/exec:", err);
        }
      });
    }

    updateButtonState();
  }

  function setupDraggableButton() {
    const button = document.getElementById("openSidebarBtn");
    if (!button) return;

    let isDragging = false;
    let startX = 0;
    let startY = 0;
    let xOffset = 0;
    let yOffset = 0;

    function onPointerDown(clientX, clientY) {
      isDragging = true;
      startX = clientX - xOffset;
      startY = clientY - yOffset;
      button.style.transition = "none";
    }

    function onPointerMove(clientX, clientY) {
      if (!isDragging) return;
      const currentX = clientX - startX;
      const currentY = clientY - startY;
      xOffset = currentX;
      yOffset = currentY;
      setTranslate(currentX, currentY, button);
    }

    function onPointerUp() {
      isDragging = false;
      button.style.transition = "";
    }

    function setTranslate(xPos, yPos, el) {
      el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
    }

    // Mouse events
    button.addEventListener("mousedown", e => onPointerDown(e.clientX, e.clientY), false);
    document.addEventListener("mousemove", e => onPointerMove(e.clientX, e.clientY), false);
    document.addEventListener("mouseup", onPointerUp, false);

    // Touch events
    button.addEventListener("touchstart", e => {
      const t = e.touches[0];
      onPointerDown(t.clientX, t.clientY);
    }, { passive: true });
    document.addEventListener("touchmove", e => {
      if (!isDragging) return;
      const t = e.touches[0];
      onPointerMove(t.clientX, t.clientY);
    }, { passive: true });
    document.addEventListener("touchend", onPointerUp, false);
  }

  function saveEdit() {
    const elements = window.ItemSelectorState.elements;
    window.ItemSelectorState.mensagemFinal = elements.editMessageTextarea.value;
    updatePreview();
    closeEditModal();
  }

  function openEditModal() {
    const elements = window.ItemSelectorState.elements;
    elements.editModal.style.display = "block";
    elements.editMessageTextarea.value = window.construirMensagemFinal();
  }

  function closeEditModal() {
    const elements = window.ItemSelectorState.elements;
    if (elements?.editModal) elements.editModal.style.display = "none";
  }

  function init() {
    addStyles();
    window.ItemSelectorState.elements = createElements();
    if (!window.ItemSelectorState.elements) {
      console.error("Falha ao criar elementos");
      return;
    }
    // append sidebar element now
    document.body.appendChild(window.ItemSelectorState.elements.sidebar);
    setupEventListeners();
    setupDraggableButton();
    loadAndFilterData();

    // Adicionar callback padr√£o
    window.ItemSelector.onItemSelected(item => {
      console.log("Novo item selecionado:", item);
    });
  }

  async function loadAndFilterData() {
    try {
      const response = await fetch(
        "https://raw.githubusercontent.com/Gusttavop/RevanAntigo/refs/heads/main/Problemas.json"
      );
      window.ItemSelectorState.jsonData = await response.json();
      console.log("JSON Data carregado:", window.ItemSelectorState.jsonData);
      filterAndDisplayItems();
    } catch (error) {
      console.error("Erro ao carregar os dados:", error);
      // fallback: manter jsonData vazio e permitir busca
    }
  }

  function normalizeString(str = "") {
    return String(str)
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "");
  }

  function filterAndDisplayItems() {
    if (!window.ItemSelectorState.elements?.searchInput) {
      console.error("Search input element not found");
      return;
    }
    const searchTerm = normalizeString(
      window.ItemSelectorState.elements.searchInput.value
    );
    const filteredItems = (window.ItemSelectorState.jsonData || []).filter(item => {
      const matchesSearch = normalizeString(item.titulo).includes(searchTerm);
      const matchesTag =
        item.infra === "Geral" ||
        window.ItemSelectorState.availableTags.has(mapInfraToTag(item.infra));
      return matchesSearch && matchesTag;
    });

    displayItems(filteredItems);
  }

  function mapInfraToTag(infra) {
    const mapping = {
      Fibra: "Fibra",
      IPTV: "IPTV",
      Telefonia: "Telefonia",
      FWA: "FWA",
      Geral: "Geral",
    };
    return mapping[infra] || "Geral";
  }

  function displayItems(items) {
    if (!validateElements()) return;

    const dd = window.ItemSelectorState.elements.dropdown;
    dd.innerHTML = "";
    items.forEach(item => {
      const li = document.createElement("li");
      li.textContent = item.titulo;
      li.addEventListener("click", () => {
        resetElementsToDefault();
        window.ItemSelectorState.selectedItem = item;
        updateUIOnSelection(item);

        console.log("Selected Item:", window.ItemSelector.getSelectedItem());
        console.log("Formatted Message:", window.ItemSelector.getFormattedMessage());
        console.log("Form Data:", window.ItemSelector.getFormData());

        if (typeof window.ItemSelectorState.onItemSelectedCallback === "function") {
          window.ItemSelectorState.onItemSelectedCallback(item);
        }
      });
      dd.appendChild(li);
    });
  }

  function validateElements() {
    const elems = window.ItemSelectorState.elements;
    const requiredElements = [
      "dropdown",
      "searchInput",
      "clearButton",
      "specificationSection",
      "externalCallCheckbox",
      "reminderCheckbox",
      "importantCheckbox",
      "observationsTextarea",
      "buttonContainer",
      "previewSection",
      "editModal",
      "editMessageTextarea",
      "saveEditButton",
      "cancelEditButton",
    ];

    for (const element of requiredElements) {
      if (!elems[element]) {
        console.error(`Required element missing: ${element}`);
        return false;
      }
    }
    return true;
  }

  function updateUIOnSelection(item) {
    const elements = window.ItemSelectorState.elements;
    resetElementsToDefault();

    elements.searchInput.value = item.titulo || "";
    elements.clearButton.style.display = "flex";
    elements.dropdown.style.display = "none";
    elements.searchInput.style.borderRadius = "10px";

    elements.specificationSection.style.display = "block";

    if (item.externo) {
      elements.externalCallCheckbox.style.display = "block";
      elements.reminderCheckbox.style.display = "none";
      const cb = elements.externalCallCheckbox.querySelector("input");
      if (cb) cb.checked = !!item.aguardar;
    } else {
      elements.externalCallCheckbox.style.display = "none";
      elements.reminderCheckbox.style.display = "block";
      const cb = elements.reminderCheckbox.querySelector("input");
      if (cb) cb.checked = !!item.lembrete;
    }

    elements.importantCheckbox.style.display = "block";
    elements.observationsTextarea.style.display = "block";
    elements.buttonContainer.style.display = "flex";
    elements.previewSection.style.display = "block";

    updateButtonState();
    updatePreview();

    // Call tagExt and log
    try {
      window.tagExt();
      console.log("tagResult ap√≥s sele√ß√£o:", window.tagResult);
    } catch (err) {
      console.error("Erro ao executar tagExt:", err);
      window.tagResult = false;
    }
  }

  function updatePreview() {
    if (!window.ItemSelectorState.selectedItem) return;

    const s = window.ItemSelectorState.selectedItem;
    window.ItemSelectorState.elements.internalLabelPreview.innerHTML = `<h4>Etiqueta Interna:</h4><p>${s.etiqueta || ""}</p>`;
    window.ItemSelectorState.elements.externalLabelPreview.innerHTML = `<h4>Etiqueta Externa:</h4><p>${s.etiqueta_externo || "N/A"}</p>`;

    const mensagemFinal = window.construirMensagemFinal();
    window.ItemSelectorState.elements.finalMessagePreview.innerHTML = `<h4>Mensagem Final:</h4><p>${mensagemFinal}</p>`;
  }

  function updateButtonState() {
    const sendButton =
      window.ItemSelectorState.elements.buttonContainer.querySelector(
        ".send-button"
      );
    const editButton =
      window.ItemSelectorState.elements.buttonContainer.querySelector(
        ".edit-button"
      );
    if (sendButton && editButton) {
      const isEnabled = !!window.ItemSelectorState.selectedItem;
      sendButton.disabled = !isEnabled;
      editButton.disabled = !isEnabled;
    }
  }

  function updateAvailableTags() {
    window.ItemSelectorState.availableTags.clear();
    document
      .querySelectorAll("div.tags > div.tag > nz-tag > span")
      .forEach(tag => {
        if (tag && tag.textContent) window.ItemSelectorState.availableTags.add(tag.textContent.trim());
      });
  }

  function resetElementsToDefault() {
    const elements = window.ItemSelectorState.elements;
    if (!elements) return;
    try {
      // Reset checkboxes
      elements.externalCallCheckbox.querySelector("input").checked = false;
      elements.reminderCheckbox.querySelector("input").checked = false;
      elements.importantCheckbox.querySelector("input").checked = false;
      elements.holderCheckbox.querySelector("input").checked = true;
    } catch (e) {
      // ignore if structure changed
    }

    // Reset input and textarea
    elements.speakerInput.value = "";
    elements.observationsTextarea.value = "";
    elements.editMessageTextarea.value = "";

    // Reset select
    const sel = elements.relationshipSelect.querySelector("select");
    if (sel) sel.selectedIndex = 0;
    window.ItemSelectorState.mensagemFinal = "";
    closeEditModal();
  }

  function closeSidebar() {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    if (sidebar) {
      sidebar.classList.remove("open");
    }
    if (overlay) {
      overlay.style.display = "none";
    }
  }

  init();

  // Fun√ß√£o principal de automa√ß√£o
  async function executarAutomacao() {
    closeSidebar();
    window.tagResult = false;
    if (document.getElementById("upload")) {
      const toggle = document.getElementById("toggle_upload");
      if (toggle) toggle.click();
    }

    const msgF = window.construirMensagemFinal();
    const textArea = document.querySelector(".text-area");
    if (textArea) {
      textArea.value = msgF;
      textArea.dispatchEvent(new Event("input", { bubbles: true }));
    }

    const importantCheckbox = document.getElementById("importantCheckbox");
    if (importantCheckbox && importantCheckbox.checked) {
      const importantButton = document.getElementById("important");
      if (importantButton) {
        importantButton.click();
        console.log("Bot√£o 'important' clicado");
      } else {
        console.log("Elemento 'important' n√£o encontrado");
      }
    }

    const sendBtn = document.getElementById("send_button");
    if (sendBtn) {
      sendBtn.click();
      console.log("Mensagem enviada");
    } else {
      console.warn("Bot√£o de envio n√£o encontrado (#send_button)");
    }

    // Verify if tag already exists before adding (case-insensitive)
    const existingTags = document.querySelectorAll(
      "div.tags > div.tag > nz-tag > span"
    );
    const desiredTag = window.ItemSelectorState.selectedItem?.etiqueta || "";
    const tagExists = Array.from(existingTags).some(
      tag => tag.textContent.trim().toLowerCase() === desiredTag.toLowerCase()
    );

    if (!tagExists && desiredTag) {
      console.log("Adicionando etiqueta");
      try {
        await adicionarEtiqueta();
      } catch (err) {
        console.error("Falha ao adicionar etiqueta:", err);
        window.tagResult = false;
      }
    } else {
      console.log("Etiqueta j√° existe ou n√£o definida, pulando adi√ß√£o");
      window.tagResult = true;
    }

    if (window.ItemSelectorState.selectedItem?.externo) {
      console.log("Finalizando caso externo");
      await finalizarExterno();
    } else if (document.getElementById("reminderCheckbox")?.checked) {
      console.log("Adicionando lembrete");
      await adicionarLembrete();
    } else {
      console.log("Finalizando caso interno");
      await finalizarInterno();
    }

    console.log("Automa√ß√£o conclu√≠da com sucesso");
  }

  // Fun√ß√£o para adicionar etiqueta
  async function adicionarEtiqueta() {
    try {
      const tagElement = await esperarElemento(
        "//nz-tag[contains(@class, 'editable-tag')]",
        150,
        5000
      );

      if (!tagElement) {
        throw new Error("Tag element not found");
      }

      tagElement.click();
      console.log("Tag element clicked successfully");

      const tagInput = await esperarElemento(
        "//*[@id='tags']/div/div/ul/li/input",
        150,
        5000
      );

      if (!tagInput) {
        throw new Error("Tag input element not found");
      }

      tagInput.click();
      tagInput.value = window.ItemSelectorState.selectedItem.etiqueta;
      tagInput.dispatchEvent(new Event("input", { bubbles: true }));

      const etiquetaInterna = window.ItemSelectorState.selectedItem.etiqueta;
      console.log(`Attempting to select tag: ${etiquetaInterna}`);

      await esperarEClicar(
        `//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(normalize-space(.), '${etiquetaInterna}')]`
      );

      await esperarElemento(
        `//li[contains(@class, 'ant-select-selection__choice')]//div[contains(text(), '${etiquetaInterna}')]`,
        150,
        5000
      );

      const concluirButton = document.querySelector(
        '[data-testid="btn-Concluir"]'
      );
      if (!concluirButton) {
        throw new Error("Concluir button not found");
      }

      concluirButton.click();
      console.log("Tag added and Concluir button clicked");

      window.tagResult = true;
    } catch (error) {
      console.error("Error in adicionarEtiqueta:", error);
      window.tagResult = false;
      throw error;
    }
  }

  // Fun√ß√£o para finalizar caso externo (mantida)
  async function finalizarExterno() {
    const etiquetaExterno =
      window.ItemSelectorState.selectedItem.etiqueta_externo || "";
    const forward = document.getElementById("forward");
    if (forward) forward.click();

    await new Promise(resolve => setTimeout(resolve, 300));

    if (document.getElementById("externalCallCheckbox")?.checked) {
      try {
        const xpathSwitch = '//lib-input-switch//button[@class="ant-switch"]';
        const xpathVerificacao =
          '//lib-input-switch//button[@class="ant-switch ant-switch-checked"]';
        await clicarComTentativas(xpathSwitch, xpathVerificacao);
        console.log("Switch clicado e verificado com sucesso!");
      } catch (error) {
        console.error("Erro ao clicar no switch:", error);
      }

      await new Promise(resolve => setTimeout(resolve, 100));
    }

    await clicarComTentativas(
      "//nz-select[@id='sector']//input",
      "//ul[contains(@class, 'ant-select-dropdown-menu')]"
    );

    await esperarElemento(
      "//ul[contains(@class, 'ant-select-dropdown-menu') and not(contains(@style, 'display: none'))]",
      150,
      20000
    );

    await esperarEClicar(
      "//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'suporte externo')]",
      150,
      20000
    );

    await new Promise(resolve => setTimeout(resolve, 200));

    await clicarComTentativas(
      "//nz-select[@id='problem']//input",
      "//ul[contains(@class, 'ant-select-dropdown-menu')]"
    );

    const problemInput = document.evaluate(
      "//nz-select[@id='problem']//input",
      document,
      null,
      XPathResult.FIRST_ORDERED_NODE_TYPE,
      null
    ).singleNodeValue;
    if (problemInput) {
      problemInput.value = etiquetaExterno;
      problemInput.dispatchEvent(new Event("input", { bubbles: true }));
    }

    await esperarEClicar(
      `//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${etiquetaExterno.toLowerCase()}')]`,
      150,
      20000
    );

    await esperarElemento(
      `//li[contains(@class, 'ant-select-selection__choice')]//div[contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${etiquetaExterno.toLowerCase()}')]`,
      150,
      20000
    );

    const servicoExterno = window.ItemSelectorState.selectedItem.servico || "";

    await esperarElementoHabilitado("//nz-select[@id='service']", 500, 20000);

    await clicarComTentativas(
      "//nz-select[@id='problem']//input",
      "//ul[contains(@class, 'ant-select-dropdown-menu')]"
    );

    await new Promise(resolve => setTimeout(resolve, 200));

    await clicarComTentativas(
      "//nz-select[@id='service']//input",
      "//ul[contains(@class, 'ant-select-dropdown-menu')]"
    );

    const serviceInput = document.evaluate(
      "//nz-select[@id='service']//input",
      document,
      null,
      XPathResult.FIRST_ORDERED_NODE_TYPE,
      null
    ).singleNodeValue;
    if (serviceInput) {
      serviceInput.value = servicoExterno;
      serviceInput.dispatchEvent(new Event("input", { bubbles: true }));
    }

    await esperarEClicar(
      `//li[contains(@class, 'ant-select-dropdown-menu-item') and contains(translate(normalize-space(.), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${servicoExterno.toLowerCase()}')]`
    );

    await esperarElemento(
      `//div[contains(@class, 'ant-select-selection-selected-value') and contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), '${servicoExterno.toLowerCase()}')]`
    );

    const continuar = document.querySelector('[data-testid="btn-Continuar"]');
    if (continuar) continuar.click();
  }

  // Fun√ß√£o para adicionar lembrete
  async function adicionarLembrete() {
    const more = document.querySelector(".more");
    if (more) more.click();
    const item = document
      .evaluate(
        "//nz-list-item[span[text()='Adicionar lembrete']]",
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      )
      .singleNodeValue;
    if (item) item.click();
    const tituloInput = document.getElementById("titulo");
    if (tituloInput) {
      tituloInput.click();
      tituloInput.value = "Fazer retorno";
      tituloInput.dispatchEvent(new Event("input", { bubbles: true }));
    }
    const concluir = document
      .evaluate(
        "//span[contains(text(), 'Concluir')]",
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      )
      .singleNodeValue;
    if (concluir) concluir.click();
  }

  // Fun√ß√£o para finalizar caso interno
  async function finalizarInterno() {
    await new Promise(resolve => setTimeout(resolve, 400));

    const more = document.querySelector(".more");
    if (more) more.click();
    const finalizar = document
      .evaluate(
        "//nz-list-item[span[text()='Finalizar']]",
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      )
      .singleNodeValue;
    if (finalizar) finalizar.click();
  }

  // Fun√ß√£o auxiliar para esperar e clicar em um elemento
  async function esperarEClicar(xpath, intervalo = 150, timeout = 10000) {
    return new Promise((resolve, reject) => {
      const startTime = Date.now();
      const intervalId = setInterval(() => {
        const elements = document.evaluate(
          xpath,
          document,
          null,
          XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
          null
        );
        for (let i = 0; i < elements.snapshotLength; i++) {
          const element = elements.snapshotItem(i);
          if (element) {
            clearInterval(intervalId);
            element.click();
            console.log(`Elemento clicado: ${xpath}`);
            resolve();
            return;
          }
        }
        if (Date.now() - startTime > timeout) {
          clearInterval(intervalId);
          console.error(`Timeout esperando pelo elemento: ${xpath}`);
          reject(new Error(`Timeout esperando pelo elemento: ${xpath}`));
        }
      }, intervalo);
    });
  }

  async function esperarElemento(xpath, intervalo = 150, timeout = 10000) {
    return new Promise((resolve, reject) => {
      const startTime = Date.now();
      const intervalId = setInterval(() => {
        const element = document.evaluate(
          xpath,
          document,
          null,
          XPathResult.FIRST_ORDERED_NODE_TYPE,
          null
        ).singleNodeValue;
        if (element) {
          clearInterval(intervalId);
          resolve(element);
        } else if (Date.now() - startTime > timeout) {
          clearInterval(intervalId);
          reject(new Error(`Timeout esperando pelo elemento: ${xpath}`));
        }
      }, intervalo);
    });
  }

  // Nova fun√ß√£o auxiliar para clicar com tentativas
  async function clicarComTentativas(
    xpathParaClicar,
    xpathParaVerificar,
    maxTentativas = 60,
    intervalo = 200
  ) {
    for (let i = 0; i < maxTentativas; i++) {
      const elementoParaClicar = document.evaluate(
        xpathParaClicar,
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      ).singleNodeValue;
      if (elementoParaClicar) {
        elementoParaClicar.click();

        await new Promise(resolve => setTimeout(resolve, 100));

        const elementoVerificacao = document.evaluate(
          xpathParaVerificar,
          document,
          null,
          XPathResult.FIRST_ORDERED_NODE_TYPE,
          null
        ).singleNodeValue;
        if (elementoVerificacao) {
          console.log("Clique bem-sucedido no input do sector.");
          return;
        }
      }

      await new Promise(resolve => setTimeout(resolve, intervalo));
    }

    throw new Error("Falha ao clicar no input do sector ap√≥s v√°rias tentativas.");
  }

  async function esperarElementoHabilitado(
    xpath,
    intervalo = 500,
    timeout = 10000
  ) {
    const startTime = Date.now();
    while (Date.now() - startTime < timeout) {
      const element = document.evaluate(
        xpath,
        document,
        null,
        XPathResult.FIRST_ORDERED_NODE_TYPE,
        null
      ).singleNodeValue;
      if (element && !element.classList.contains("ant-select-disabled")) {
        return element;
      }
      await new Promise(resolve => setTimeout(resolve, intervalo));
    }
    throw new Error(`Timeout esperando pelo elemento habilitado: ${xpath}`);
  }

  async function esperarElementoClicavel(
    xpath,
    intervalo = 150,
    timeout = 10000
  ) {
    return await esperarElemento(xpath, intervalo, timeout);
  }

})();
